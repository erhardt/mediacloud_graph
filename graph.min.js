var DEFAULT_PARAMS={GRAPH_WIDTH:570,GRAPH_HEIGHT:500,MAX_SIZE:20,MIN_SIZE:2,MAX_FONT_SIZE:36,MIN_FONT_SIZE:4,MAX_MIN_ZOOM_FONT_SIZE:10,X_MARGIN:60,HIST_MARGIN:4,Y_MARGIN:60,DURATION:1500,LINK_DELAY_WITH_TRANS:1300,LINK_DELAY_NO_TRANS:50,LINK_DURATION:1E3,LABEL_SIZE_CUTOFF:6,ZOOM_SPEED:1,MAX_ZOOM:10,MIN_ZOOM:1,LABEL_OFFSET:0.3,PI_TIME:0,MAX_PI_TIME:100},POPPED_OUT_PARAMS={GRAPH_WIDTH:0.8*$(window).width()-37,GRAPH_HEIGHT:0.7*$(window).height(),MAX_SIZE:30,MIN_SIZE:3,MAX_FONT_SIZE:36,MIN_FONT_SIZE:8,
LABEL_SIZE_CUTOFF:9};$.extend(window,DEFAULT_PARAMS);
var LINK_DELAY=LINK_DELAY_WITH_TRANS,TIMEOUT=LINK_DELAY+LINK_DURATION+750,DISABLE_TRANS=!1,is_playing=!1,player_timeouts=[],last_value=0,radius=d3.scale.linear().domain([0,1]).range([MIN_SIZE,MAX_SIZE]),fontSize=d3.scale.linear().domain([MIN_SIZE,MAX_SIZE]).range([MIN_FONT_SIZE,MAX_FONT_SIZE]).clamp(!0),minFontSize=d3.scale.linear().domain([1,MAX_ZOOM]).range([MIN_FONT_SIZE,MAX_MIN_ZOOM_FONT_SIZE]).clamp(!0),siteCategory=d3.scale.category20(),zoom_level=1;
nodeFieldsToShow=[{key:"url",label:"URL"},{key:"code_media_type",label:"Media Type"},{key:"story_count",label:"Story Count"}];selected_node=all_frames=null;var svg=setupGraph("#graph");
d3.json("final_frames.json",function(a){$("#date-slider").slider({min:0,max:a.length-1,range:"min",change:function(c,b){b.value!=last_value&&(animate(a[b.value]),last_value=b.value)}});all_frames=a;animate(a[0]);histogram(a);updateHistogram(0);d3.select("#play").on("click",function(c,b){play_toggle(a)});setupEventListeners();$(".ui-slider-handle").focus()});
function animate(a,c){a.nodes=a.nodes.map(function(c){c.normedPosition=normalizePosition(a.boundaries,c.position);c.normedSize=normalizeSize(a.size_range,c.size);c.denormPosition=denormalizePosition(c.normedPosition);return c});var b=svg.selectAll("g.node").data(a.nodes,function(a){return a.id}),e=svg.selectAll("line.link").data(a.links,function(a){return a.source+"-"+a.target}),d=addGroup(b.enter());addCircle(d);addText(d);addLink(a,e.enter());b.on("click",highlightNode);d=updateGroup(b);updateCircle(d);
updateText(d);updateLink(e,a);d=b.exit().classed("removing",!0).transition();d.select("circle").attr("r",0);d.select("text.label").attr("font-size",0);d.remove();e.exit().remove();hideLinks(e);hideLabels(b);d=all_frames.indexOf(a);updateHistogram(d);all_frames.length-1==d&&is_playing&&(player_timeouts=[],is_playing=!1,d3.select("#button-label").text("Play"),d3.select("#play button").classed("playing",is_playing));updateFrameNarrative(a);userSelected=d3.select("g.node.selected:not(.removing)");userSelected.empty()?
null!=selected_node&&d3.select("#node-info").html("<em>Does not appear in current week</em>"):populateNodeInfo(userSelected.data()[0]);d=d3.select("g.node.selected");d3.select("#show-links:checked").empty()?d.empty()||showLinks(getNodeLinks(d),LINK_DELAY):showLinks(e,LINK_DELAY);d3.select("#show-labels:checked").empty()?d3.select("g.node.selected").empty()||showLabels(d3.select("g.node.selected")):showLabels(b)}
function setupGraph(a){a=d3.select(a).append("svg").attr("width",GRAPH_WIDTH).attr("height",GRAPH_HEIGHT).attr("pointer-events","all").append("g").attr("id","zoom-wrap").call(d3.behavior.zoom().scaleExtent([1,MAX_ZOOM]).on("zoom",redraw)).append("g");a.append("svg:rect").attr("width",GRAPH_WIDTH).attr("height",GRAPH_HEIGHT).attr("fill","white");var c=a.append("svg:defs");c.append("svg:marker").attr("id","triangle").attr("viewBox","0 0 10 10").attr("refX",1).attr("refY",5).attr("markerWidth",6).attr("markerHeight",
6).attr("orient","auto").append("path").attr("d","M 0 0 L 10 5 L 0 10 z");c=c.append("svg:radialGradient").attr("id","highlight").attr("r","100%");c.append("svg:stop").attr("offset","0%").attr("stop-color","#FFFF7D");c.append("svg:stop").attr("offset","100%").attr("stop-color","#FFFF7D").attr("stop-opacity","0");d3.select("#date-slider").style("width",GRAPH_WIDTH-2*X_MARGIN+"px");d3.select("#graph-wrapper").style("width",GRAPH_WIDTH+"px");return a}
function titleToNode(a){return d3.selectAll("g.node").filter(function(c){return c.label==a})}
function setupEventListeners(){d3.select("#show-links").on("click",function(){d3.select(this).filter(":checked").empty()?setLinkEndAttr(d3.selectAll("line.link").classed("hidden",!0)):showLinks(d3.selectAll("line.link"))});d3.select("#show-labels").on("click",function(){d3.select(this).filter(":checked").empty()?hideLabels(d3.selectAll("g.node:not(.selected)")):showLabels(d3.selectAll("g.node"))});d3.select("#graph").on("click",unhighlightNode,!0);d3.select("#disable-trans").on("click",function(){d3.select(this).filter(":checked").empty()?
(DISABLE_TRANS=!1,LINK_DELAY=LINK_DELAY_WITH_TRANS):(DISABLE_TRANS=!0,LINK_DELAY=LINK_DELAY_NO_TRANS)});d3.select("html").on("click",function(){$(".ui-slider-handle").focus()});$("#dialog-modal").dialog({autoOpen:!1,modal:!0,title:"About this visualization",width:600,buttons:[{text:"OK",click:function(){$(this).dialog("close")}}]});d3.select("#zoom-level").text(function(){return"Zoom: "+zoom_level.toFixed(1)+"x"});$("#about").click(function(){$("#dialog-modal").dialog("open")});$("#zoom-slider").slider({orientation:"vertical",
range:"min",min:MIN_ZOOM,max:MAX_ZOOM,value:MIN_ZOOM,slide:function(a,c){var b=document.createEvent("WheelEvent");b.initWebKitWheelEvent(0,c.value-zoom_level,window);document.getElementById("zoom-wrap").dispatchEvent(b)}});d3.select("#pop-out").on("click",popOut)}
function popOut(){unhighlightNode();$.extend(window,POPPED_OUT_PARAMS);radius=d3.scale.linear().domain([0,1]).range([MIN_SIZE,MAX_SIZE]);fontSize=d3.scale.linear().domain([MIN_SIZE,MAX_SIZE]).range([MIN_FONT_SIZE,MAX_FONT_SIZE]).clamp(!0);minFontSize=d3.scale.linear().domain([1,MAX_ZOOM]).range([MIN_FONT_SIZE,MAX_MIN_ZOOM_FONT_SIZE]).clamp(!0);zoom_level=1;$("#map").dialog({modal:!0,position:{my:"center top",at:"center top",of:window},width:0.8*$(window).width(),close:popIn}).addClass("popped-out");
$("#graph svg").remove();$("#pop-out").css("display","none");svg=setupGraph("#graph");animate(all_frames[0]);last_value=0;histogram(all_frames);updateHistogram(0)}
function popIn(){unhighlightNode();$.extend(window,DEFAULT_PARAMS);radius=d3.scale.linear().domain([0,1]).range([MIN_SIZE,MAX_SIZE]);fontSize=d3.scale.linear().domain([MIN_SIZE,MAX_SIZE]).range([MIN_FONT_SIZE,MAX_FONT_SIZE]).clamp(!0);minFontSize=d3.scale.linear().domain([1,MAX_ZOOM]).range([MIN_FONT_SIZE,MAX_MIN_ZOOM_FONT_SIZE]).clamp(!0);zoom_level=1;$("#graph svg").remove();$("#map").dialog("destroy").removeClass("popped-out");$("#pop-out").css("display","inline");svg=setupGraph("#graph");animate(all_frames[0]);
last_value=0;histogram(all_frames);updateHistogram(0)}function redraw(){zoom(d3.event.scale,d3.event.translate)}
function zoom(a,c){zoom_level=a;d3.select("#zoom-level").text(function(){return"Zoom: "+zoom_level.toFixed(1)+"x"});svg.attr("transform","translate("+c+")scale("+zoom_level+")");d3.selectAll("circle").attr("r",function(a){return radius(a.normedSize)/zoom_level}).style("stroke-width",function(a){return 2/zoom_level});d3.selectAll("line.link").style("stroke-width",function(){return 1/zoom_level});correctFontSizes()}
function correctFontSizes(){d3.selectAll("g.node:not(.selected) text.label").attr("font-size",function(a){var c=fontSize.range([minFontSize(zoom_level),MAX_FONT_SIZE]);d3.select(this).classed("hidden",function(a){return d3.select("#show-labels:checked").empty()||c(radius(a.normedSize))<LABEL_SIZE_CUTOFF});return c(radius(a.normedSize))/zoom_level});d3.selectAll("g.node.selected text.label").attr("font-size",function(){return MAX_FONT_SIZE/zoom_level})}
function addGroup(a){return a.append("g").attr("class","node").attr("id",function(a){return"node-"+a.id}).attr("transform",function(a){return"translate("+a.denormPosition.x+","+a.denormPosition.y+")"}).classed("not-selected",function(a){return!d3.select(".not-selected").empty()&&a.id!=selected_node})}
function addLink(a,c){var b=c.insert("line","g.node").attr("class","hidden link").attr("id",function(a){return"link-"+a.source+"-"+a.target}).datum(function(c){return updateInteralLinkPosition(c,a)});minimizeLinks(b)}function addCircle(a){a.append("circle").attr("r",0).style("fill",function(a){return siteCategory(a.code_media_type)})}
function addText(a){a.append("text").attr("text-anchor","middle").attr("dy",LABEL_OFFSET+"em").attr("class","label").text(function(a){return a.label}).classed("hidden",function(a){return d3.select("#show-labels:checked").empty()||fontSize(radius(a.normedSize))<LABEL_SIZE_CUTOFF}).attr("font-size",function(a){return fontSize(radius(a.normedSize))})}
function updateGroup(a){a.classed("narrated",function(a){return a.narrative}).classed("selected",function(a){return selected_node==a.id});a=DISABLE_TRANS?a:a.transition().duration(DURATION);a.attr("transform",function(a){return"translate("+a.denormPosition.x+","+a.denormPosition.y+")"});return a}function updateCircle(a){a.select("circle").attr("r",function(a){return radius(a.normedSize)}).style("fill",function(a){return siteCategory(a.code_media_type)})}
function updateText(a){a.select("text.label").attr("font-size",function(a){return fontSize(radius(a.normedSize))})}function updateLink(a,c){a.datum(function(a){return updateInteralLinkPosition(a,c)})}
function formatDateRange(a,c){var b=[];b[b.length]="January";b[b.length]="February";b[b.length]="March";b[b.length]="April";b[b.length]="May";b[b.length]="June";b[b.length]="July";b[b.length]="August";b[b.length]="September";b[b.length]="October";b[b.length]="November";b[b.length]="December";return a.getUTCMonth()==c.getUTCMonth()?b[a.getUTCMonth()].substr(0,3)+" "+a.getUTCDate()+" - "+c.getUTCDate()+", "+c.getFullYear():a.getFullYear()==c.getFullYear()?b[a.getUTCMonth()].substr(0,3)+" "+a.getUTCDate()+
" - "+b[c.getUTCMonth()].substr(0,3)+" "+c.getUTCDate()+", "+c.getFullYear():b[a.getUTCMonth()].substr(0,3)+" "+a.getUTCDate()+", "+a.getFullYear()+" - "+b[c.getUTCMonth()].substr(0,3)+" "+c.getUTCDate()+", "+c.getFullYear()}
function updateFrameNarrative(a){a.narrative?(d3.select("#frame-info p").html(linkNodes(a.narrative)),d3.select("#frame-info p").property("scrollTop",0)):d3.select("#frame-info p").html("");d3.selectAll(".node-link").on("click",function(){unhighlightNode();var a=titleToNode(d3.select(this).attr("title"));highlightNode.call(a.node(),a.datum());d3.event.preventDefault()},!0);if(a.start_date&&a.end_date){var c=new Date(a.start_date),b=new Date(a.end_date);d3.select("#start-date").text(formatDateRange(c,
b));d3.select("#site-count").text(a.nodes.length+" media sources")}else d3.select("#start-date").text("")}function showLabels(a){a.selectAll("text.label").classed("hidden",function(a){return fontSize(radius(a.normedSize))<LABEL_SIZE_CUTOFF})}function hideLabels(a){a.selectAll("text.label").classed("hidden",!0)}function showLinks(a,c){c?maximizeLinks(a.classed("hidden",!1).transition().delay(c).duration(LINK_DURATION)):maximizeLinks(a.classed("hidden",!1).transition().duration(LINK_DURATION))}
function hideLinks(a){DISABLE_TRANS?minimizeLinks(a.classed("hidden",!0)):minimizeLinks(a.classed("hidden",!0).transition())}
function histogram(a){var c=a.map(function(a){return a.nodes.length}),b=d3.scale.linear().domain([0,Math.max.apply(null,c)]).range([3,d3.select("#histogram").node().clientHeight]),e=(d3.select("#histogram").node().clientWidth-(c.length-1)*HIST_MARGIN)/c.length;d3.select("#histogram").selectAll(".bar").data(a).enter().append("div").attr("class","bar-wrap").attr("title",function(a){return formatDateRange(new Date(a.start_date),new Date(a.end_date))+": "+a.nodes.length+" media sources"}).style("height",
function(a){return b.range()[1]+"px"}).on("click",function(a,b){changeToFrame(b)}).append("div").attr("class","bar").style("height",function(a){return b(a.nodes.length)+"px"});d3.select("#histogram").selectAll(".bar-wrap").style("margin-left",function(a,b){return 0==b?0:HIST_MARGIN+"px"}).style("width",function(){return e+"px"})}function updateHistogram(a){d3.selectAll("#histogram .bar").classed("highlight",function(c,b){return b==a})}
function getNodeLinks(a,c){"function"==typeof a.datum&&(a=a.datum());return d3.selectAll("line.link").filter(function(b){switch(c){case "inbound":return b.target==a.id;case "outbound":return b.source==a.id;default:return b.target==a.id||b.source==a.id}})}
function highlightNode(a){d3.select("#mediaSource").style("display","block");d3.select(this).classed("selected",!0);selected_node=this.id.slice(5);d3.select("#show-labels:checked").empty()&&d3.selectAll("text.label").classed("hidden",!0);d3.select(this).select("text.label").classed("hidden",!1).attr("font-size",function(a){return MAX_FONT_SIZE/zoom_level});d3.selectAll("g.node").classed("not-selected",function(c){return c!=a});populateNodeInfo(a);hideLinks(d3.selectAll("line.link"));showLinks(getNodeLinks(a))}
function unhighlightNode(){d3.select("#mediaSource").style("display","none");selected_node=null;d3.selectAll("g.node").classed("not-selected",!1).classed("selected",!1);hideLinks(d3.selectAll("line.link"));d3.select("#show-labels:checked").empty()&&hideLabels(d3.selectAll("g.node"));d3.selectAll("#node-info, #site-image, #node-narrative p").html("");d3.select("#node-name").text("");correctFontSizes()}
function updateInteralLinkPosition(a,c){var b=d3.select("#node-"+a.source),e=d3.select("#node-"+a.target);b.empty()||e.empty()?a.position={x1:0,y1:0,x2:0,y2:0}:a.position={x1:b.datum().denormPosition.x,y1:b.datum().denormPosition.y,x2:e.datum().denormPosition.x,y2:e.datum().denormPosition.y};return a}function minimizeLinks(a){setLinkEndAttr(a)}function maximizeLinks(a){setLinkEndAttr(a,!0)}
function setLinkEndAttr(a,c){a.attr("x1",function(a){return a.position.x1}).attr("y1",function(a){return a.position.y1});c?a.attr("x2",function(a){return a.position.x2}).attr("y2",function(a){return a.position.y2}):a.attr("x2",function(a){return a.position.x1}).attr("y2",function(a){return a.position.y1})}function normalizePosition(a,c){var b=d3.scale.linear().domain([a[0],a[2]]).range([0,1]),e=d3.scale.linear().domain([a[1],a[3]]).range([0,1]);return{x:b(c.x),y:e(c.y)}}
function denormalizePosition(a){return{x:a.x*(GRAPH_WIDTH-2*X_MARGIN)+X_MARGIN,y:GRAPH_HEIGHT-a.y*(GRAPH_HEIGHT-2*Y_MARGIN)-Y_MARGIN}}function normalizeSize(a,c){return d3.scale.linear().domain([5,50]).range([0,1])(c)}function linkNodes(a){return a.replace(/\[([^\]]*)::([^\]]*)\]/g,'<a href="#" class="node-link" title="$2">$1</a>')}
function populateNodeInfo(a){d3.select("#node-info").html(nodeFieldsToShow.map(function(c){value="url"==c.key?'<a href="'+a[c.key]+'" target="_blank">'+a[c.key]+"</a>":a[c.key];return"<dt>"+c.label+"</dt><dd>"+value+"</dd>"}).reduce(function(a,b){return a+b})+"<dt>Inbound Links</dt><dd>"+getNodeLinks(a,"inbound")[0].length+"</dd><dt>Outbound Links</dt><dd>"+getNodeLinks(a,"outbound")[0].length+"</dd>");a.screenshot?d3.select("#site-image").html('<dt>Screenshot</dt><img src="'+a.screenshot+'" />'):
d3.select("#site-image").html("");d3.select("#node-name").text(a.label);a.narrative?d3.select("#node-narrative p").text(a.narrative):d3.select("#node-narrative p").text("")}
function play_toggle(a){is_playing?(player_timeouts.forEach(function(a){clearTimeout(a)}),player_timeouts=[],is_playing=!1,d3.select("#button-label").text("Play")):(a.forEach(function(c,b){last_value==a.length-1&&(last_value=0);b>=last_value&&player_timeouts.push(setTimeout(changeToFrame,(b-last_value)*TIMEOUT,b))}),is_playing=!0,d3.select("#button-label").text("Pause"));d3.select("#play button").classed("playing",is_playing)}function changeToFrame(a){$("#date-slider").slider("value",a)};
